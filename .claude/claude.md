# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a Turborepo monorepo containing a full-stack enterprise web application for Coesco, a manufacturing company. The application includes sales management (CRM), production tracking, form builder, performance sheets, and warehouse management capabilities.

## Repository Structure

```
├── apps/
│   ├── client/     # React frontend (Vite + TypeScript)
│   ├── server/     # Node.js backend (Express + TypeScript)
│   └── fanuc/      # C# Fanuc adapter (DO NOT MODIFY)
├── packages/
│   ├── types/      # Shared TypeScript types (auto-generated from Prisma)
│   └── eslint-config/
```

## Tech Stack

**Frontend (apps/client):**
- Framework: React 19 with Vite
- Language: TypeScript (ESM)
- Styling: Tailwind CSS v4 + DaisyUI
- Routing: React Router v7
- State: React Context + hooks
- Build: Vite with SWC

**Backend (apps/server):**
- Framework: Express.js
- Language: TypeScript (CommonJS)
- Database: PostgreSQL with Prisma ORM
- Auth: JWT + bcrypt, Microsoft SSO via MSAL
- Real-time: Socket.IO
- Caching: Redis (ioredis)
- Testing: Jest + Supertest

**Shared:**
- Monorepo: Turborepo
- Package Manager: npm (v11.0.0)
- Node: >=18

## Common Commands

### Root Level
```bash
npm run build          # Build all packages/apps
npm run dev            # Run all apps in development mode
npm run lint           # Lint all packages/apps
npm run format         # Format code with Prettier
npm run check-types    # Type-check all packages/apps
```

### Server (apps/server)
```bash
npm run dev            # Start development server with nodemon
npm run build          # Compile TypeScript to dist/
npm start              # Run production build

# Database
npm run db:generate    # Generate Prisma client + repositories + types
npm run db:migrate     # Create and apply migrations (dev)
npm run db:migrate:deploy   # Apply migrations (production)
npm run db:migrate:status   # Check migration status
npm run db:reset       # Reset database (WARNING: deletes data)
npm run pipeline       # Run data pipeline script

# Testing
npm test               # Run all tests
npm run test:watch     # Run tests in watch mode
npm run test:coverage  # Run tests with coverage report
npm run test:ci        # Run tests in CI mode

# Code Quality
npm run lint           # Lint TypeScript files
npm run lint:fix       # Lint and auto-fix issues
npm run swagger        # Generate Swagger documentation
```

### Client (apps/client)
```bash
npm run dev            # Start Vite dev server (port 5173)
npm run build          # Type-check and build for production
npm run preview        # Preview production build
npm run lint           # Lint with ESLint
npm run optimize-images # Optimize images with Squoosh
```

## Code Architecture

### Backend Architecture

#### Repository Pattern
The backend uses an auto-generated repository pattern:

1. **Base Repository** (`apps/server/src/repositories/_base.repository.ts`):
   - Abstract base class providing CRUD operations
   - Built-in query building, pagination, filtering, soft-delete handling
   - Fuzzy search and full-text search capabilities
   - Audit logging integration
   - Employee context scoping

2. **Generated Repositories** (`apps/server/src/repositories/*.repository.ts`):
   - **NEVER MANUALLY EDIT THESE FILES** - they are auto-generated by `service-generator.ts`
   - Run `npm run db:generate` after modifying `schema.prisma` to regenerate
   - Each Prisma model gets its own repository class
   - Support custom annotations in schema for advanced features:
     - `@searchFields(field1:weight1, field2:weight2)` - Define weighted full-text search
     - `@sortFields(alias: [field1, field2])` - Define custom sort aliases
     - `@transform(name: SQL_EXPRESSION)` - Define computed fields

3. **Service Layer** (`apps/server/src/services/`):
   - Business logic sits here
   - Use repositories for data access
   - Handle complex operations, external API calls, caching

#### Path Aliases
Both server and client use `@/` as an alias for `src/`:
```typescript
import { logger } from "@/utils/logger";
import { userRepository } from "@/repositories";
```

Server uses `tsconfig-paths` for runtime resolution, client uses Vite's resolve.alias.

#### Routing Structure
Routes are organized by domain in `apps/server/src/routes/`:
- `auth.routes.ts` - Authentication (public)
- `admin.routes.ts` - Admin panel (role-protected)
- `sales.routes.ts` - CRM, quotes, journeys
- `production.routes.ts` - Machines, statuses
- `form.routes.ts` - Form builder and submissions
- `core.routes.ts` - Shared CRUD endpoints
- `legacy.routes.ts` - Legacy system integration

All routes except `/auth`, `/system`, and `/webhooks` are protected by the `protect` middleware.

#### Database Patterns

**Soft Deletes:**
Most models include a `deletedAt` field for soft deletion. BaseRepository automatically filters soft-deleted records unless `includeDeleted: true` is passed.

**Audit Logging:**
Changes to most entities are automatically logged to the `AuditLog` table via middleware, tracking who made changes and what changed.

**Employee Context:**
Many operations are scoped to the authenticated employee's context using `getEmployeeContext()` utility.

### Frontend Architecture

#### Routing
Routes are defined using a module-based system in `apps/client/src/config/modules.ts`:
- Each module (sales, production, admin, etc.) has pages
- Pages can have children for nested routes
- Routes are generated dynamically in `App.tsx`
- Role-based access control via `ProtectedRoute` component

#### Styling
- **Theme System**: All theme colors are defined in `apps/client/src/index.css` using CSS custom properties
- **Color Palette**:
  - Primary colors: `--primary`, `--secondary`
  - Surface colors: `--background`, `--foreground`, `--surface`
  - Text colors: `--text`, `--text-muted`
  - Status colors: `--error`, `--success`, `--warning`, `--info` (USE ONLY FOR STATUS)
  - Utility: `--border`, `--shadow`
- **Dark Mode**: Uses `.dark` class with separate color values
- **Important Rules**:
  - ALWAYS reference theme colors from `index.css`, never hardcode colors
  - Status colors (error/success/warning/info) should ONLY be used for status indicators
  - Never use status colors for non-status UI elements

#### Component Patterns
- Functional components with hooks
- Custom hooks in `apps/client/src/hooks/`
- Shared components in `apps/client/src/components/`

### Shared Types Package

The `packages/types` package contains TypeScript types auto-generated from Prisma schema:

- **Auto-generated files**: `src/_auto-generated.ts` and individual model files
- **DO NOT manually edit** auto-generated files
- **Custom types**: Add to `packages/types/src/custom/` and export from there
- **Regeneration**: Run `npm run db:generate` in `apps/server` to regenerate types

Both apps import types from `@coesco/types`.

## Key Development Workflows

### Adding a New Database Model

1. Add the model to `apps/server/prisma/schema.prisma`
2. Optionally add custom annotations (`@searchFields`, `@sortFields`, `@transform`)
3. Run `npm run db:generate` in `apps/server`:
   - Creates migration
   - Generates Prisma client
   - Generates repository classes
   - Generates TypeScript types in `packages/types`
   - Auto-runs lint:fix

### Working with Forms

The app includes a custom form builder system (`apps/server/src/routes/form.routes.ts` and related pages):
- Dynamic form schemas with pages, sections, fields
- Conditional logic rules
- Field validation
- Submission tracking
- External access links for public forms

### Working with Quotes/Configuration Builder

The configuration builder (`apps/client/src/pages/sales/configuration-builder.tsx`) allows:
- Building product configurations with options
- Option rules (show/hide/require based on other selections)
- Performance sheet linking
- Quote generation with revisions

## Important Constraints

### DO NOT Modify
- `apps/server/src/repositories/*.repository.ts` (except `_base.repository.ts`) - Auto-generated
- `packages/types/src/*.ts` (except `custom/` folder) - Auto-generated
- `apps/fanuc/*` - External C# adapter, do not touch

### Code Style
- Do not add comments unless explicitly requested
- Use ESLint and Prettier configurations
- Follow existing patterns in the codebase

### Server Guidelines
- Never attempt to start a server instance manually
- Use repositories for database access, not raw Prisma calls
- Implement business logic in services, not routes
- Use TypeScript path aliases (`@/`)

### Client Guidelines
- Reference theme colors from `src/index.css`, never hardcode
- Status colors (error/success/warning/info) ONLY for status elements
- Use the module system for new pages
- Respect role-based access controls

## Testing

Server tests use Jest + Supertest:
```bash
npm test                    # Run all tests
npm run test:watch          # Watch mode
npm run test:coverage       # With coverage
```

Test files in `apps/server/src/__tests__/`

## Environment Configuration

Both apps require environment variables:

**Server** (`apps/server/.env`):
- `DATABASE_URL` - PostgreSQL connection string
- `JWT_SECRET` - Secret for JWT tokens
- `PORT` - Server port (default: 3000)
- Redis, SMTP, Microsoft SSO credentials

**Client** (`apps/client/.env`):
- `VITE_API_URL` - Backend API URL

## Database Migrations

Always use Prisma migrations for schema changes:
```bash
npm run db:migrate          # Create and apply migration
npm run db:migrate:deploy   # Production deployment
npm run db:migrate:status   # Check status
```

Never modify the database schema directly.

## Additional Notes

- The app uses Socket.IO for real-time updates (machine statuses, notifications)
- Redis caching layer for frequently accessed data
- Microsoft SSO integration via MSAL
- PWA support with offline capabilities
- Image optimization scripts for production assets
- Legacy system integration via ODBC (`legacy.routes.ts`)
